name: PHP Composer

on:
    push:

permissions:
    contents: read

jobs:
    phpunit:
        runs-on: ubuntu-latest

        strategy:
            fail-fast: false
            matrix:
                include:
                    - php-version: '7.1'
                      symfony-version: '3.4.*'
                      phpunit-version: '7.5.20'
                    - php-version: '7.4'
                      symfony-version: '4.0.*'
                      phpunit-version: '9.5.28'
                    - php-version: '8.0'
                      symfony-version: '5.0.*'
                      phpunit-version: '9.5.28'
                    - php-version: '8.1'
                      symfony-version: '6.0.*'
                      phpunit-version: '9.5.28'
                    - php-version: '8.1'
                      symfony-version: '^6.2'
                      phpunit-version: '9.5.28'

        steps:
            - uses: "shivammathur/setup-php@v2"
              with:
                  php-version: "${{ matrix.php-version }}"

            - uses: actions/checkout@v3

            - name: Set versions
              run: |
                  sed -i 's/\^3.4|\^4.0|\^5.0|\^6.0/${{ matrix.symfony-version }}/g' composer.json
                  sed -i 's/\^7.5|\^9.5/${{ matrix.phpunit-version }}/g' composer.json

            - name: Validate composer.json and composer.lock
              run: composer validate --strict

            - name: Cache Composer packages
              id: composer-cache
              uses: actions/cache@v3
              with:
                  path: vendor
                  key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-php-

            - name: Install dependencies
              uses: ramsey/composer-install@v2

            - name: Run test suite
              run: composer run-script phpunit

    phpstan:
        runs-on: ubuntu-latest
        steps:
            - uses: "shivammathur/setup-php@v2"
              with:
                  php-version: "7.4"

            - uses: actions/checkout@v3

            - name: Cache Composer packages
              id: composer-cache
              uses: actions/cache@v3
              with:
                  path: vendor
                  key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-php-

            - name: Install dependencies
              uses: ramsey/composer-install@v2

            - name: PHPStan analyse
              run: composer run-script phpstan-analise
